#!/bin/bash

# Get the current branch name
CURRENT_BRANCH=$(git symbolic-ref --short HEAD)

# Check if we're on main or master
if [[ "$CURRENT_BRANCH" == "main" || "$CURRENT_BRANCH" == "master" ]]; then
    echo "‚ùå Pushing to $CURRENT_BRANCH branch is strictly forbidden!"
    echo "Please create a feature branch and make a pull request."
    exit 1
fi

# Only run cargo build if this is a Rust project
if [ -f "Cargo.toml" ]; then
    # Check if FORCE_PUSH environment variable is set or --force flag is used
    if [[ "$FORCE_PUSH" == "1" ]]; then
        echo "‚ö†Ô∏è  Warning: Force push enabled. Skipping build checks..."
        exit 0
    fi

    echo "Running pre-push checks..."

    # Run cargo build
    echo "üì¶ Running cargo build..."
    cargo build
    if [ $? -ne 0 ]; then
        echo "‚ùå cargo build failed."
        echo "To push anyway, you can:"
        echo "1. Use: FORCE_PUSH=1 git push"
        echo "2. Use: git push --force-with-lease"
        exit 1
    fi

    echo "‚úÖ Build passed. Proceeding with push."
fi

exit 0
